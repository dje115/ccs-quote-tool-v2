# Discovery to CRM Workflow

## Overview
This document explains the lead progression workflow from campaign discoveries to CRM customers.

## Status Progression

```
┌─────────────────────────────────────────────────────────────────┐
│                    CAMPAIGN SYSTEM                               │
│                                                                  │
│  DISCOVERY (Campaign Lead)                                      │
│  - Generated by Lead Generation Campaigns                       │
│  - AI-analyzed businesses from Google Maps                      │
│  - Contains: company info, postcode, AI analysis                │
│  - Stored in `lead_generation_leads` table                      │
│                                                                  │
│                          ↓                                       │
│                  [Convert to CRM Lead]                          │
│                          ↓                                       │
└─────────────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────────────┐
│                      CRM SYSTEM                                  │
│                                                                  │
│  1. LEAD (Initial Contact)                                      │
│     - First stage in CRM                                        │
│     - Initial discovery converted to CRM                        │
│     - Ready for first contact/qualification                     │
│                          ↓                                       │
│  2. PROSPECT (Qualified Interest)                               │
│     - Lead has been contacted and qualified                     │
│     - Shows genuine interest                                    │
│     - Opportunity identified                                    │
│                          ↓                                       │
│  3a. OPPORTUNITY (Active Sales Cycle)                           │
│      - Active sales process                                     │
│      - Quote/proposal stage                                     │
│      - Negotiation in progress                                  │
│                          ↓                                       │
│      CUSTOMER (Won Deal)                                        │
│      - Deal closed successfully                                 │
│      - Active customer                                          │
│                                                                  │
│  OR                                                             │
│                                                                  │
│  3b. Direct to CUSTOMER                                         │
│      - Skip opportunity stage                                   │
│      - Quick wins/small deals                                   │
│      - Direct conversions                                       │
│                                                                  │
│  Additional Statuses:                                           │
│  - COLD_LEAD: Not responding/low priority                       │
│  - INACTIVE: No longer pursuing                                 │
│  - LOST: Deal lost to competitor/no decision                    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

## Key Terminology

### Discovery
- **What**: AI-generated business leads from campaigns
- **Where**: Displayed in "Discoveries" page (formerly "Leads" page)
- **Source**: Lead Generation Campaigns using Google Maps + AI
- **Table**: `lead_generation_leads`
- **Status Values**: `new`, `contacted`, `qualified`, `converted`, `rejected`, `duplicate`

### CRM Lead
- **What**: First stage customer in CRM system
- **Where**: Customer database with `status = LEAD`
- **Source**: Converted from Discovery or manually created
- **Table**: `customers`
- **Status**: `CustomerStatus.LEAD`

### CRM Customer
- **What**: Any record in the CRM system (regardless of stage)
- **Table**: `customers`
- **Status Options**: 
  - `DISCOVERY` (deprecated - now starts at LEAD)
  - `LEAD` (initial contact)
  - `PROSPECT` (qualified)
  - `OPPORTUNITY` (active sales)
  - `CUSTOMER` (won)
  - `COLD_LEAD` (low priority)
  - `INACTIVE` (dormant)
  - `LOST` (unsuccessful)

## Conversion Process

### Frontend (Discoveries Page)
1. User views list of discoveries from campaigns
2. Clicks "Convert to CRM Lead" button (green checkmark)
3. Confirms conversion dialog
4. Discovery is converted and user is redirected to new CRM customer record

### Backend Process
```python
# In LeadGenerationService.convert_lead_to_customer()

1. Fetch discovery (campaign lead) from database
2. Check if already converted (prevent duplicates)
3. Create new Customer record:
   - Copy all discovery data
   - Set status = CustomerStatus.LEAD  # First CRM stage
   - Link back to original discovery
4. Update discovery:
   - Set status = LeadStatus.CONVERTED
   - Store customer_id reference
   - Record conversion timestamp
5. Commit to database
```

### Data Transferred
When converting Discovery → CRM Lead:
- Company name
- Website
- Company registration (if found by AI)
- Contact phone
- Contact email
- Address & postcode
- Business sector
- Company size
- Lead score
- LinkedIn URL & data
- Companies House data
- Website analysis
- Google Maps data

## API Endpoints

### Get All Discoveries
```
GET /api/v1/campaigns/leads/all
```
Returns all campaign leads (discoveries) for current tenant

### Convert Discovery to CRM Lead
```
POST /api/v1/campaigns/leads/{lead_id}/convert
```
Creates Customer record with LEAD status

### Get Discovery Details
```
GET /api/v1/campaigns/leads/{lead_id}
```
Returns single discovery details

## UI Updates

### Discoveries Page (`/leads`)
- **Title**: "Discoveries" (was "Leads")
- **Stats Cards**:
  - Total Discoveries
  - New Discoveries
  - Qualified
  - High Score
- **Table Columns**:
  - Company (with business sector)
  - Contact (name, email, phone)
  - Location (postcode, company size)
  - Status
  - Lead Score (with progress bar)
  - Campaign (campaign name + source)
  - Created (date)
  - Actions (View Details + Convert to CRM Lead)

### Discovery Detail Page (`/leads/:id`)
- Shows full discovery information
- "Convert to CRM Lead" button
- Links back to campaign
- Shows AI analysis if available

### Customer Status Management
Once in CRM, users can move customers through stages:
- LEAD → PROSPECT (qualify)
- PROSPECT → OPPORTUNITY (active sales) → CUSTOMER (win)
- PROSPECT → CUSTOMER (direct conversion)
- Any status → COLD_LEAD / INACTIVE / LOST

## Database Schema

### lead_generation_leads (Discoveries)
```sql
- id (UUID)
- tenant_id (UUID)
- campaign_id (UUID)
- company_name (String)
- postcode (String)
- contact_name, contact_email, contact_phone
- business_sector, company_size
- lead_score (Integer)
- status (LeadStatus enum)
- converted_to_customer_id (UUID, nullable)
- conversion_date (DateTime, nullable)
- external_data (JSONB) - AI/API data
- created_at, updated_at
```

### customers (CRM Records)
```sql
- id (UUID)
- tenant_id (UUID)
- company_name (String)
- status (CustomerStatus enum) - LEAD, PROSPECT, OPPORTUNITY, CUSTOMER, etc.
- lead_score (Integer)
- website, main_phone, main_email
- billing_address, billing_postcode
- business_sector, business_size_category
- company_registration, registration_confirmed
- linkedin_url, linkedin_data (JSONB)
- companies_house_data (JSONB)
- website_data (JSONB)
- google_maps_data (JSONB)
- created_at, updated_at, created_by
```

## Future Enhancements

1. **Bulk Conversion**: Convert multiple discoveries at once
2. **Auto-qualification**: AI-powered automatic LEAD → PROSPECT promotion
3. **Duplicate Detection**: Check for existing customers before conversion
4. **Conversion Analytics**: Track conversion rates by campaign
5. **Re-conversion Prevention**: Warning if trying to convert already-converted discovery
6. **Status Change History**: Audit trail of status changes in CRM

## Notes

- **DISCOVERY status deprecated**: Previously, converted leads started at DISCOVERY status. Now they start at LEAD for clearer workflow.
- **Campaign leads vs CRM leads**: "Discovery" = campaign lead, "Lead" (when in CRM context) = CustomerStatus.LEAD
- **One-way conversion**: Converting a discovery to CRM is one-way. The discovery remains in the campaign system but marked as converted.
- **Lead score preserved**: The AI-calculated lead score from the campaign is carried over to the CRM record.

